
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
  
    <title>MySQL中的锁 | 爱撒谎的男孩</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="不才陈某">
    

    
    <meta name="description" content="MySQL中的锁数据库引擎
数据库的引擎分为MyISAM和InnoDB和其他的
不同的数据库引擎默认使用的锁是不同的
MyISAM默认使用的是表级别锁，InnoDB默认使用的是行级锁
我们在使用的时候，一般都是使用InnoDB，支持事务，事务安全等功能

锁的分类
表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。
行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL中的锁">
<meta property="og:url" content="http://chenjiabing666.github.io/2018/06/26/MySQL中的锁/index.html">
<meta property="og:site_name" content="爱撒谎的男孩">
<meta property="og:description" content="MySQL中的锁数据库引擎
数据库的引擎分为MyISAM和InnoDB和其他的
不同的数据库引擎默认使用的锁是不同的
MyISAM默认使用的是表级别锁，InnoDB默认使用的是行级锁
我们在使用的时候，一般都是使用InnoDB，支持事务，事务安全等功能

锁的分类
表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。
行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小">
<meta property="og:image" content="https://www.2cto.com/uploadfile/Collfiles/20150810/20150810092332321.png">
<meta property="og:image" content="https://www.2cto.com/uploadfile/Collfiles/20150810/20150810092333322.png">
<meta property="og:image" content="https://gitee.com/chenjiabing666/Blog-file/raw/master/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20200310211704.jpg">
<meta property="og:updated_time" content="2020-03-13T06:04:49.536Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL中的锁">
<meta name="twitter:description" content="MySQL中的锁数据库引擎
数据库的引擎分为MyISAM和InnoDB和其他的
不同的数据库引擎默认使用的锁是不同的
MyISAM默认使用的是表级别锁，InnoDB默认使用的是行级锁
我们在使用的时候，一般都是使用InnoDB，支持事务，事务安全等功能

锁的分类
表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。
行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小">
<meta name="twitter:image" content="https://www.2cto.com/uploadfile/Collfiles/20150810/20150810092332321.png">

    
    <link rel="alternative" href="/atom.xml" title="爱撒谎的男孩" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/avatar.jpg" alt="爱撒谎的男孩" title="爱撒谎的男孩"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="爱撒谎的男孩">爱撒谎的男孩</a></h1>
				<h2 class="blog-motto">微信公众号：码猿技术专栏</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives/">归档</a></li>
					
						<li><a href="/about/">关于我</a></li>
					
					<li>
 					
						<form class="search" action="https://chenjiabing666.github.io/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 14509119671822170000 ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>	
			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/06/26/MySQL中的锁/" title="MySQL中的锁" itemprop="url">MySQL中的锁</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="不才陈某" target="_blank" itemprop="author">不才陈某</a>
		
  <p class="article-time">
    <time datetime="2018-06-26T14:58:12.000Z" itemprop="datePublished"> 发表于 2018-06-26</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL中的锁"><span class="toc-number">1.</span> <span class="toc-text">MySQL中的锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库引擎"><span class="toc-number">1.1.</span> <span class="toc-text">数据库引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#锁的分类"><span class="toc-number">1.2.</span> <span class="toc-text">锁的分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB锁的模式"><span class="toc-number">1.3.</span> <span class="toc-text">InnoDB锁的模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-事务（Transaction）及其ACID属性"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.事务（Transaction）及其ACID属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-并发事务带来的问题"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.并发事务带来的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-事务隔离级别"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.事务隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务４种隔离级别比较"><span class="toc-number">1.3.4.</span> <span class="toc-text">事务４种隔离级别比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#两种行级锁"><span class="toc-number">1.3.5.</span> <span class="toc-text">两种行级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#两种表级锁"><span class="toc-number">1.3.6.</span> <span class="toc-text">两种表级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB行锁兼容模式"><span class="toc-number">1.3.7.</span> <span class="toc-text">InnoDB行锁兼容模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB行锁实现原理"><span class="toc-number">1.3.8.</span> <span class="toc-text">InnoDB行锁实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分析"><span class="toc-number">1.3.8.1.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例"><span class="toc-number">1.3.9.</span> <span class="toc-text">实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#行锁的三种情形"><span class="toc-number">1.3.10.</span> <span class="toc-text">行锁的三种情形</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#间隙锁（Next-Key锁）"><span class="toc-number">1.3.10.1.</span> <span class="toc-text">间隙锁（Next-Key锁）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#实例-1"><span class="toc-number">1.3.10.1.1.</span> <span class="toc-text">实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么时候使用表锁"><span class="toc-number">1.3.11.</span> <span class="toc-text">什么时候使用表锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于死锁"><span class="toc-number">1.3.12.</span> <span class="toc-text">关于死锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">1.5.</span> <span class="toc-text">参考文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#笔者有话说"><span class="toc-number">1.6.</span> <span class="toc-text">笔者有话说</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="MySQL中的锁"><a href="#MySQL中的锁" class="headerlink" title="MySQL中的锁"></a>MySQL中的锁</h1><h2 id="数据库引擎"><a href="#数据库引擎" class="headerlink" title="数据库引擎"></a>数据库引擎</h2><ul>
<li>数据库的引擎分为<code>MyISAM</code>和<code>InnoDB</code>和其他的</li>
<li>不同的数据库引擎默认使用的锁是不同的</li>
<li><code>MyISAM</code>默认使用的是<strong>表级别锁</strong>，<code>InnoDB</code>默认使用的是<code>行级锁</code></li>
<li>我们在使用的时候，一般都是使用<code>InnoDB</code>，支持事务，事务安全等功能</li>
</ul>
<h2 id="锁的分类"><a href="#锁的分类" class="headerlink" title="锁的分类"></a>锁的分类</h2><ul>
<li><strong>表级锁</strong>：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。</li>
<li><strong>行级锁</strong>：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</li>
<li><strong>页面锁</strong>：开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般</li>
</ul>
<h2 id="InnoDB锁的模式"><a href="#InnoDB锁的模式" class="headerlink" title="InnoDB锁的模式"></a>InnoDB锁的模式</h2><ul>
<li>InnoDB与MyISAM的最大不同有两点：一是支持事务（TRANSACTION）；二是采用了行级锁。</li>
<li><p>行级锁和表级锁本来就有许多不同之处，另外，事务的引入也带来了一些新问题。</p>
</li>
<li><p><strong>默认使用的是行级锁</strong></p>
</li>
</ul>
<h3 id="1-事务（Transaction）及其ACID属性"><a href="#1-事务（Transaction）及其ACID属性" class="headerlink" title="1.事务（Transaction）及其ACID属性"></a>1.事务（Transaction）及其ACID属性</h3><ul>
<li><p>事务是由一组SQL语句组成的逻辑处理单元，事务具有4属性，通常称为事务的ACID属性。</p>
</li>
<li><p>原性性（Actomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。</p>
</li>
<li>一致性（Consistent）：在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以操持完整性；事务结束时，所有的内部数据结构（如B树索引或双向链表）也都必须是正确的。</li>
<li>隔离性（Isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。</li>
<li>持久性（Durable）：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</li>
</ul>
<h3 id="2-并发事务带来的问题"><a href="#2-并发事务带来的问题" class="headerlink" title="2.并发事务带来的问题"></a>2.并发事务带来的问题</h3><ul>
<li><p>相对于串行处理来说，并发事务处理能大大增加数据库资源的利用率，提高数据库系统的事务吞吐量，从而可以支持可以支持更多的用户。但并发事务处理也会带来一些问题，主要包括以下几种情况。</p>
</li>
<li><p><strong>更新丢失</strong>（Lost Update）：当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题——最后的更新覆盖了其他事务所做的更新。例如，两个编辑人员制作了同一文档的电子副本。每个编辑人员独立地更改其副本，然后保存更改后的副本，这样就覆盖了原始文档。最后保存其更改保存其更改副本的编辑人员覆盖另一个编辑人员所做的修改。如果在一个编辑人员完成并提交事务之前，另一个编辑人员不能访问同一文件，则可避免此问题</p>
</li>
<li><strong>脏读</strong>（Dirty Reads）：一个事务正在对一条记录做修改，在这个事务并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”的数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做“脏读”。</li>
<li><strong>不可重复读</strong>（Non-Repeatable Reads）：一个事务在读取某些数据已经发生了改变、或某些记录已经被删除了！这种现象叫做“不可重复读”。</li>
<li><strong>幻读</strong>（Phantom Reads）：一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读”。</li>
</ul>
<h3 id="3-事务隔离级别"><a href="#3-事务隔离级别" class="headerlink" title="3.事务隔离级别"></a>3.事务隔离级别</h3><ul>
<li>在并发事务处理带来的问题中，“更新丢失”通常应该是完全避免的。但防止更新丢失，并不能单靠数据库事务控制器来解决，需要应用程序对要更新的数据<strong>加必要的锁</strong>来解决，因此，防止更新丢失应该是应用的责任。</li>
<li>“脏读”、“不可重复读”和“幻读”，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决。数据库实现事务隔离的方式，基本可以分为以下两种。</li>
<li>一种是在读取数据前，对其加锁，阻止其他事务对数据进行修改。</li>
<li><p>另一种是不用加任何锁，通过一定机制生成一个数据请求时间点的一致性数据快照（Snapshot），并用这个快照来提供一定级别（语句级或事务级）的一致性读取。从用户的角度，好像是数据库可以提供同一数据的多个版本，因此，这种技术叫做数据多版本并发控制（ＭultiVersion Concurrency Control，简称MVCC或MCC），也经常称为多版本数据库。</p>
</li>
<li><p>数据库的事务隔离级别越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使事务在一定程度上“串行化”进行，这显然与“并发”是矛盾的，同时，不同的应用对读一致性和事务隔离程度的要求也是不同的，比如许多应用对“不可重复读”和“幻读”并不敏感，可能更关心数据并发访问的能力。</p>
</li>
<li><p>为了解决“隔离”与“并发”的矛盾，ISO/ANSI SQL92定义了４个事务隔离级别，每个级别的隔离程度不同，允许出现的副作用也不同，应用可以根据自己业务逻辑要求，通过选择不同的隔离级别来平衡＂隔离＂与＂并发＂的矛盾</p>
</li>
</ul>
<h3 id="事务４种隔离级别比较"><a href="#事务４种隔离级别比较" class="headerlink" title="事务４种隔离级别比较"></a>事务４种隔离级别比较</h3><table>
<thead>
<tr>
<th>隔离级别/读数据一致性及允许的并发副作用</th>
<th>读数据一致性</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td>未提交读（Read uncommitted）</td>
<td>最低级别，只能保证不读取物理上损坏的数据</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>已提交度（Read committed）</td>
<td>语句级</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>可重复读（Repeatable read）</td>
<td>事务级</td>
<td>否</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>可序列化（Serializable）</td>
<td>最高级别，事务级</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
</tbody>
</table>
<h3 id="两种行级锁"><a href="#两种行级锁" class="headerlink" title="两种行级锁"></a>两种行级锁</h3><ol>
<li><p><strong>共享锁（S）</strong>：允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁</p>
<ul>
<li><p><strong>共享锁好像只读锁，可以允许多个事务同时读这行数据，但是不允许修改（排他锁）</strong></p>
</li>
<li><p>如果一个事务获取共享锁了，那么其他事务只能获取这一行的共享锁，而不能获取这行的排他锁</p>
</li>
</ul>
</li>
<li><p><strong>排他锁（X）</strong>：允许获得排他锁的事务更新数据，但是组织其他事务获得相同数据集的共享锁和排他锁。</p>
<ul>
<li><strong>相当于只写锁，只能同时允许一个事务对该行数据的更新，并且也不允许其他的事务读这行的数据</strong></li>
<li>如果一个事务获取了这行数据的排他锁，那么其他的事务将不能获取这行数据的共享锁和排它锁，只有等待前一个事务释放才有机会获取</li>
</ul>
</li>
</ol>
<ul>
<li><strong>对于<code>UPDATE</code>、<code>DELETE</code>和<code>INSERT</code>语句，InnoDB会自动给涉及及数据集加排他锁（Ｘ）</strong></li>
<li><strong>对于普通<code>SELECT</code>语句，InnoDB不会任何锁；事务可以通过以下语句显示给记录集加共享锁或排锁。</strong><ul>
<li>共享锁（Ｓ）：<code>SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE</code></li>
<li>排他锁（X）：<code>SELECT * FROM table_name WHERE ... FOR UPDATE</code></li>
</ul>
</li>
</ul>
<h3 id="两种表级锁"><a href="#两种表级锁" class="headerlink" title="两种表级锁"></a>两种表级锁</h3><ul>
<li><strong>意向共享锁（IS）</strong>：表示事务准备给数据行加入共享锁，也就是说一个数据行加共享锁前必须先取得该表的IS锁</li>
<li><strong>意向排他锁（IX）</strong>：类似上面，表示事务准备给数据行加入排他锁，说明事务在一个数据行加排他锁前必须先取得该表的IX锁。</li>
<li><strong>意向锁是InnoDB自动加的，不需用户干预</strong></li>
</ul>
<h3 id="InnoDB行锁兼容模式"><a href="#InnoDB行锁兼容模式" class="headerlink" title="InnoDB行锁兼容模式"></a>InnoDB行锁兼容模式</h3><ul>
<li><strong>当一个事务请求的锁模式与当前的锁兼容，InnoDB就将请求的锁授予该事务；反之如果请求不兼容，则该事务就等待锁释放。</strong></li>
</ul>
<table>
<thead>
<tr>
<th>当前锁模式/是否兼容/请求锁模式</th>
<th>X</th>
<th>IX</th>
<th>S</th>
<th>IS</th>
</tr>
</thead>
<tbody>
<tr>
<td>X</td>
<td>冲突</td>
<td>冲突</td>
<td>冲突</td>
<td>冲突</td>
</tr>
<tr>
<td>IX</td>
<td>冲突</td>
<td>兼容</td>
<td>冲突</td>
<td>兼容</td>
</tr>
<tr>
<td>S</td>
<td>冲突</td>
<td>冲突</td>
<td>兼容</td>
<td>兼容</td>
</tr>
<tr>
<td>IS</td>
<td>冲突</td>
<td>兼容</td>
<td>兼容</td>
<td>兼容</td>
</tr>
</tbody>
</table>
<h3 id="InnoDB行锁实现原理"><a href="#InnoDB行锁实现原理" class="headerlink" title="InnoDB行锁实现原理"></a>InnoDB行锁实现原理</h3><ul>
<li><strong>InnoDB行锁是通过给<code>索引项</code>加锁实现的，如果没有索引，InnoDB会通过隐藏的聚簇索引来对记录加锁。</strong></li>
<li><strong>也就是说：如果不通过索引条件检索数据，那么InnoDB将对表中所有数据加锁，实际效果跟表锁一样。</strong></li>
</ul>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><ul>
<li>我们知道数据库会为主键<code>id</code>创建唯一性索引，如果一个事务执行<code>select * from user where id=1 for update</code>，那么执行完成之后数据库仅仅是为<code>id=1</code>这行的数据添加<code>排他锁</code>，其他事务对其他行的数据还是可以获取共享锁和排他锁的，即是其他事务还是可以对其他行的数据执行增删改查的。但是对于<code>id=1</code>这行的数据只能<code>select</code>不能更新插入。如果执行了<code>update user set name=&quot;Jack&quot; where id=1</code>，会自动为<code>id=1</code>这行数据添加排他锁，其他的事务对改行数据不能做任何的操作（可以<code>select</code>），但是可以对其他行的数据仍然可以执行操作</li>
<li>此时如果一个事务执行了<code>update user set name=&quot;Jack&quot; where age=22</code>，因为<code>age</code>不是索引，那么会自动添加<code>表级锁</code>锁住<code>user</code>表中的全部数据，那么此时所有的数据在另外一个事务中只能查询了，不能执行更新和插入了</li>
<li>此时如果我们为<code>age</code>添加索引：<code>create index age_index on user(age)</code>，再执行<code>update user set name=&quot;Jack&quot; where age=22</code>，那么此时添加的就是<code>行级锁</code>，仅仅锁住的是<code>age=22</code>的那些行，另外的事务还是可以操作其他行的数据</li>
</ul>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><ul>
<li>加入共享锁，<code>where id</code>，id默认是唯一索引</li>
<li><img src="https://www.2cto.com/uploadfile/Collfiles/20150810/20150810092332321.png" alt=""></li>
</ul>
<ul>
<li>排他锁的例子<ul>
<li>使用<code>select * from .... for update</code> 添加排他锁</li>
</ul>
</li>
<li><img src="https://www.2cto.com/uploadfile/Collfiles/20150810/20150810092333322.png" alt=""></li>
</ul>
<h3 id="行锁的三种情形"><a href="#行锁的三种情形" class="headerlink" title="行锁的三种情形"></a>行锁的三种情形</h3><ul>
<li><strong>以下的三种情形都是针对索引项的，不是索引项的会自动使用表级锁锁住全表</strong></li>
</ul>
<ol>
<li><strong>Record lock</strong> ：对<strong>索引项</strong>加锁，即锁定一条记录。</li>
<li><strong>Gap lock：</strong>对<strong>索引项</strong>之间的<code>间隙</code>、对第一条记录前的间隙或最后一条记录后的间隙加锁，即锁定一个范围的记录，不包含记录本身</li>
<li><strong>Next-key Lock</strong>：锁定一个范围的记录并包含记录本身（上面两者的结合）。</li>
</ol>
<h4 id="间隙锁（Next-Key锁）"><a href="#间隙锁（Next-Key锁）" class="headerlink" title="间隙锁（Next-Key锁）"></a>间隙锁（Next-Key锁）</h4><ul>
<li><p>只针对带有区间的操作，比如<code>&gt;30</code>或者<code>&lt;3</code>等</p>
</li>
<li><p>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做“间隙(GAP)”，InnoDB也会对这个“间隙”加锁，这种锁机制不是所谓的间隙锁（Next-Key锁）。</p>
</li>
<li><p>举例来说，假如emp表中只有101条记录，其<code>empid</code>（主键，唯一索引）的值分别是1,2,…,100,101，下面的SQL：</p>
<p><code>SELECT * FROM emp WHERE empid &gt; 100 FOR UPDATE</code></p>
</li>
<li><p>是一个范围条件的检索，InnoDB不仅会对符合条件的empid值为101的记录加锁，也会对empid大于101（这些记录并不存在）的“间隙”加锁。</p>
</li>
<li><p>InnoDB使用间隙锁的目的，一方面是为了防止幻读，以满足相关隔离级别的要求，对于上面的例子，要是不使用间隙锁，如果其他事务插入了empid大于100的任何记录，那么本事务如果再次执行上述语句，就会发生幻读；另一方面，是为了满足其恢复和复制的需要。有关其恢复和复制对机制的影响，以及不同隔离级别下InnoDB使用间隙锁的情况。</p>
</li>
<li><p>很显然，在使用范围条件检索并锁定记录时，InnoDB这种加锁机制会阻塞符合条件范围内键值的并发插入，这往往会造成严重的锁等待。因此，在实际开发中，尤其是并发插入比较多的应用，我们要尽量优化业务逻辑，尽量使用相等条件来访问更新数据，避免使用范围条件。</p>
</li>
</ul>
<h5 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h5><ul>
<li>我们给<code>age</code>添加了索引，那么在一个事务中执行<code>select * from user where age&gt;22 for update</code> 或者<code>update user set name=&quot;Jack&quot; where age&gt;22</code> ，都会为<code>user</code>表中<code>age&gt;22</code>这个区间的数据添加<code>间隙锁</code>那么只要<code>age</code>的范围在<code>22~positive infinity</code>之间的数据另外一个事务都不可以更新或者插入，在<code>age&lt;=22</code>之间的数据是可以操作的，比如<code>insert</code>，<code>update</code></li>
</ul>
<h3 id="什么时候使用表锁"><a href="#什么时候使用表锁" class="headerlink" title="什么时候使用表锁"></a>什么时候使用表锁</h3><ul>
<li><p>对于InnoDB表，在绝大部分情况下都应该使用行级锁，因为事务和行锁往往是我们之所以选择InnoDB表的理由。但在个另特殊事务中，也可以考虑使用表级锁。</p>
</li>
<li><p>第一种情况是：事务需要更新大部分或全部数据，表又比较大，如果使用默认的行锁，不仅这个事务执行效率低，而且可能造成其他事务长时间锁等待和锁冲突，这种情况下可以考虑使用表锁来提高该事务的执行速度。</p>
</li>
<li><p>第二种情况是：事务涉及多个表，比较复杂，很可能引起死锁，造成大量事务回滚。这种情况也可以考虑一次性锁定事务涉及的表，从而避免死锁、减少数据库因事务回滚带来的开销。</p>
</li>
<li><p>当然，应用中这两种事务不能太多，否则，就应该考虑使用ＭyISAＭ表。</p>
</li>
<li><p>在InnoDB下 ，使用表锁要注意以下两点。</p>
</li>
<li><p>（１）使用LOCK TALBES虽然可以给InnoDB加表级锁，但必须说明的是，表锁不是由InnoDB存储引擎层管理的，而是由其上一层ＭySQL Server负责的，仅当autocommit=0、innodb_table_lock=1（默认设置）时，InnoDB层才能知道MySQL加的表锁，ＭySQL Server才能感知InnoDB加的行锁，这种情况下，InnoDB才能自动识别涉及表级锁的死锁；否则，InnoDB将无法自动检测并处理这种死锁。</p>
</li>
<li><p>（２）在用LOCAK TABLES对InnoDB锁时要注意，要将AUTOCOMMIT设为0，否则ＭySQL不会给表加锁；事务结束前，不要用UNLOCAK TABLES释放表锁，因为UNLOCK TABLES会隐含地提交事务；COMMIT或ROLLBACK产不能释放用LOCAK TABLES加的表级锁，必须用UNLOCK TABLES释放表锁，正确的方式见如下语句。</p>
</li>
<li><p>例如，如果需要写表t1并从表t读，可以按如下做：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">SET AUTOCOMMIT=0;</div><div class="line">LOCAK TABLES t1 WRITE, t2 READ, ...;</div><div class="line">[do something with tables t1 and here];</div><div class="line">COMMIT;</div><div class="line">UNLOCK TABLES;</div></pre></td></tr></table></figure>
<h3 id="关于死锁"><a href="#关于死锁" class="headerlink" title="关于死锁"></a>关于死锁</h3><ul>
<li>ＭyISAM表锁是deadlock free的，这是因为ＭyISAM总是一次性获得所需的全部锁，要么全部满足，要么等待，因此不会出现死锁。但是在InnoDB中，除单个SQL组成的事务外，锁是逐步获得的，这就决定了InnoDB发生死锁是可能的。</li>
<li>发生死锁后，InnoDB一般都能自动检测到，并使一个事务释放锁并退回，另一个事务获得锁，继续完成事务。但在涉及外部锁，或涉及锁的情况下，InnoDB并不能完全自动检测到死锁，这需要通过设置锁等待超时参数innodb_lock_wait_timeout来解决。需要说明的是，这个参数并不是只用来解决死锁问题，在并发访问比较高的情况下，如果大量事务因无法立即获取所需的锁而挂起，会占用大量计算机资源，造成严重性能问题，甚至拖垮数据库。我们通过设置合适的锁等待超时阈值，可以避免这种情况发生。</li>
<li>通常来说，死锁都是应用设计的问题，通过调整业务流程、数据库对象设计、事务大小、以及访问数据库的SQL语句，绝大部分都可以避免。下面就通过实例来介绍几种死锁的常用方法。</li>
<li>（１）在应用中，如果不同的程序会并发存取多个表，应尽量约定以相同的顺序为访问表，这样可以大大降低产生死锁的机会。如果两个session访问两个表的顺序不同，发生死锁的机会就非常高！但如果以相同的顺序来访问，死锁就可能避免。</li>
<li>（２）在程序以批量方式处理数据的时候，如果事先对数据排序，保证每个线程按固定的顺序来处理记录，也可以大大降低死锁的可能。</li>
<li>（３）在事务中，如果要更新记录，应该直接申请足够级别的锁，即排他锁，而不应该先申请共享锁，更新时再申请排他锁，甚至死锁。</li>
<li>（４）在REPEATEABLE-READ隔离级别下，如果两个线程同时对相同条件记录用SELECT…ROR UPDATE加排他锁，在没有符合该记录情况下，两个线程都会加锁成功。程序发现记录尚不存在，就试图插入一条新记录，如果两个线程都这么做，就会出现死锁。这种情况下，将隔离级别改成READ COMMITTED，就可以避免问题。</li>
<li>（５）当隔离级别为READ COMMITED时，如果两个线程都先执行SELECT…FOR UPDATE，判断是否存在符合条件的记录，如果没有，就插入记录。此时，只有一个线程能插入成功，另一个线程会出现锁等待，当第１个线程提交后，第２个线程会因主键重出错，但虽然这个线程出错了，却会获得一个排他锁！这时如果有第３个线程又来申请排他锁，也会出现死锁。对于这种情况，可以直接做插入操作，然后再捕获主键重异常，或者在遇到主键重错误时，总是执行ROLLBACK释放获得的排他锁。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>对于ＭyISAM的表锁，主要有以下几点</strong><br>（１）共享读锁（S）之间是兼容的，但共享读锁（S）和排他写锁（X）之间，以及排他写锁之间（X）是互斥的，也就是说读和写是串行的。</p>
<p>（２）在一定条件下，ＭyISAM允许查询和插入并发执行，我们可以利用这一点来解决应用中对同一表和插入的锁争用问题。</p>
<p>（３）ＭyISAM默认的锁调度机制是写优先，这并不一定适合所有应用，用户可以通过设置LOW_PRIPORITY_UPDATES参数，或在INSERT、UPDATE、DELETE语句中指定LOW_PRIORITY选项来调节读写锁的争用。</p>
<p>（４）由于表锁的锁定粒度大，读写之间又是串行的，因此，如果更新操作较多，ＭyISAM表可能会出现严重的锁等待，可以考虑采用InnoDB表来减少锁冲突。</p>
<p><strong>对于InnoDB表，主要有以下几点</strong></p>
<p>（１）InnoDB的行销是基于索引实现的，如果不通过索引访问数据，InnoDB会使用表锁。</p>
<p>（２）InnoDB间隙锁机制，以及InnoDB使用间隙锁的原因。</p>
<p>（３）在不同的隔离级别下，InnoDB的锁机制和一致性读策略不同。</p>
<p>（４）ＭySQL的恢复和复制对InnoDB锁机制和一致性读策略也有较大影响。</p>
<p>（５）锁冲突甚至死锁很难完全避免。</p>
<p><strong>在了解InnoDB的锁特性后，用户可以通过设计和SQL调整等措施减少锁冲突和死锁，包括：</strong></p>
<ul>
<li>尽量使用较低的隔离级别</li>
<li>精心设计索引，并尽量使用索引访问数据，使加锁更精确，从而减少锁冲突的机会。</li>
<li>选择合理的事务大小，小事务发生锁冲突的几率也更小。</li>
<li>给记录集显示加锁时，最好一次性请求足够级别的锁。比如要修改数据的话，最好直接申请排他锁，而不是先申请共享锁，修改时再请求排他锁，这样容易产生死锁。</li>
<li>不同的程序访问一组表时，应尽量约定以相同的顺序访问各表，对一个表而言，尽可能以固定的顺序存取表中的行。这样可以大减少死锁的机会。</li>
<li>尽量用相等条件访问数据，这样可以避免间隙锁对并发插入的影响。</li>
<li>不要申请超过实际需要的锁级别；除非必须，查询时不要显示加锁。</li>
<li>对于一些特定的事务，可以使用表锁来提高处理速度或减少死锁的可能。</li>
</ul>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a href="http://www.cnblogs.com/chenqionghe/p/4845693.html" target="_blank" rel="external">http://www.cnblogs.com/chenqionghe/p/4845693.html</a></li>
<li><a href="http://www.cnblogs.com/chenqionghe/p/4845693.html" target="_blank" rel="external">http://www.cnblogs.com/chenqionghe/p/4845693.html</a></li>
</ul>
<h2 id="笔者有话说"><a href="#笔者有话说" class="headerlink" title="笔者有话说"></a>笔者有话说</h2><ul>
<li>最近建了一个微信交流群，提供给大家一个交流的平台，扫描下方笔者的微信二维码，备注【交流】，我会把大家拉进群</li>
</ul>
<p><img src="https://gitee.com/chenjiabing666/Blog-file/raw/master/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20200310211704.jpg" alt=""></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库干货篇/">数据库干货篇</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/SQL/">SQL</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://chenjiabing666.github.io/2018/06/26/MySQL中的锁/" data-title="MySQL中的锁 | 爱撒谎的男孩" data-tsina="5651317821" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/06/26/MySQL触发器/" title="MySQL触发器">
  <strong>上一篇：</strong><br/>
  <span>
  MySQL触发器</span>
</a>
</div>


<div class="next">
<a href="/2018/06/26/Mysql存储过程和存储函数/"  title="Mysql存储过程和存储函数">
 <strong>下一篇：</strong><br/> 
 <span>Mysql存储过程和存储函数
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL中的锁"><span class="toc-number">1.</span> <span class="toc-text">MySQL中的锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库引擎"><span class="toc-number">1.1.</span> <span class="toc-text">数据库引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#锁的分类"><span class="toc-number">1.2.</span> <span class="toc-text">锁的分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB锁的模式"><span class="toc-number">1.3.</span> <span class="toc-text">InnoDB锁的模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-事务（Transaction）及其ACID属性"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.事务（Transaction）及其ACID属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-并发事务带来的问题"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.并发事务带来的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-事务隔离级别"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.事务隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务４种隔离级别比较"><span class="toc-number">1.3.4.</span> <span class="toc-text">事务４种隔离级别比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#两种行级锁"><span class="toc-number">1.3.5.</span> <span class="toc-text">两种行级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#两种表级锁"><span class="toc-number">1.3.6.</span> <span class="toc-text">两种表级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB行锁兼容模式"><span class="toc-number">1.3.7.</span> <span class="toc-text">InnoDB行锁兼容模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB行锁实现原理"><span class="toc-number">1.3.8.</span> <span class="toc-text">InnoDB行锁实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分析"><span class="toc-number">1.3.8.1.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例"><span class="toc-number">1.3.9.</span> <span class="toc-text">实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#行锁的三种情形"><span class="toc-number">1.3.10.</span> <span class="toc-text">行锁的三种情形</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#间隙锁（Next-Key锁）"><span class="toc-number">1.3.10.1.</span> <span class="toc-text">间隙锁（Next-Key锁）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#实例-1"><span class="toc-number">1.3.10.1.1.</span> <span class="toc-text">实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么时候使用表锁"><span class="toc-number">1.3.11.</span> <span class="toc-text">什么时候使用表锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于死锁"><span class="toc-number">1.3.12.</span> <span class="toc-text">关于死锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">1.5.</span> <span class="toc-text">参考文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#笔者有话说"><span class="toc-number">1.6.</span> <span class="toc-text">笔者有话说</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Elasticsearch/" title="Elasticsearch">Elasticsearch<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hibernate/" title="Hibernate">Hibernate<sup>12</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Web/" title="Java-Web">Java-Web<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/MyBatis/" title="MyBatis">MyBatis<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Redis/" title="Redis">Redis<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/Spring/" title="Spring">Spring<sup>39</sup></a></li>
		  
		
		  
			<li><a href="/categories/SpringBoot/" title="SpringBoot">SpringBoot<sup>16</sup></a></li>
		  
		
		  
			<li><a href="/categories/Struts2/" title="Struts2">Struts2<sup>12</sup></a></li>
		  
		
		  
			<li><a href="/categories/docker/" title="docker">docker<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/java学习/" title="java学习">java学习<sup>35</sup></a></li>
		  
		
		  
			<li><a href="/categories/java并发编程/" title="java并发编程">java并发编程<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/python/" title="python">python<sup>19</sup></a></li>
		  
		
		  
			<li><a href="/categories/web前端/" title="web前端">web前端<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/分布式/" title="分布式">分布式<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库干货篇/" title="数据库干货篇">数据库干货篇<sup>20</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据结构与算法/" title="数据结构与算法">数据结构与算法<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/杂谈/" title="杂谈">杂谈<sup>22</sup></a></li>
		  
		
		  
			<li><a href="/categories/设计模式/" title="设计模式">设计模式<sup>9</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>39</sup></a></li>
			
		
			
				<li><a href="/tags/杂谈/" title="杂谈">杂谈<sup>22</sup></a></li>
			
		
			
				<li><a href="/tags/java基础/" title="java基础">java基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/python爬虫/" title="python爬虫">python爬虫<sup>18</sup></a></li>
			
		
			
				<li><a href="/tags/java并发编程/" title="java并发编程">java并发编程<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/SpringBoot/" title="SpringBoot">SpringBoot<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/SQL/" title="SQL">SQL<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/分布式/" title="分布式">分布式<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Struts2/" title="Struts2">Struts2<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/Hibernate/" title="Hibernate">Hibernate<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/数据结构与算法/" title="数据结构与算法">数据结构与算法<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/设计模式/" title="设计模式">设计模式<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/java-IO编程/" title="java IO编程">java IO编程<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Elasticsearch/" title="Elasticsearch">Elasticsearch<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/MyBatis/" title="MyBatis">MyBatis<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/web前端/" title="web前端">web前端<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/docker/" title="docker">docker<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>3</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://gitee.com/chenjiabing666/Blog-file/raw/master/%E4%B8%83%E7%A7%92%E7%BC%96%E7%A8%8B.jpg" target="_blank" title="微信公众号">微信公众号</a>
            
          </li>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.zhihu.com/people/xiao-ming-64-34-45/activities" target="_blank" title="本人知乎">本人知乎</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.cnblogs.com/Chenjiabing/" target="_blank" title="本人博客园">本人博客园</a>
            
          </li>
        
          <li>
            
            	<a href="https://blog.csdn.net/qq_34162294" target="_blank" title="本人CSDN">本人CSDN</a>
            
          </li>
        
          <li>
            
            	<a href="https://juejin.im/user/2506542244708072" target="_blank" title="本人掘金">本人掘金</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 欢迎关注微信公众号：码猿技术专栏 <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	 <script type="text/javascript">(function(){document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));var bdcs = document.createElement('script');bdcs.type = 'text/javascript';bdcs.async = true;bdcs.src = 'http://znsv.baidu.com/customer_search/api/js?sid=14509119671822169205' + '&plate_url=' + encodeURIComponent(window.location.href) + '&t=' + Math.ceil(new Date()/3600000);var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(bdcs, s);})();</script>
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/5651317821" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/chenjiabing666" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/155022807" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/https://www.zhihu.com/people/xiao-ming-64-34-45" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="不才陈某">不才陈某</a>
		
		
		</p>
		
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    $('#toc.toc-aside').css('display', 'block').addClass('fadeIn');//新加的，打开文章时自动隐藏左边的栏
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'chenjiabing666';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'null', 'null');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1261577779'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1261577779' type='text/javascript'%3E%3C/script%3E"));</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

    <script type="text/javascript" src="/js/src/love.js"></script>

  </body>
  
  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
</html>
